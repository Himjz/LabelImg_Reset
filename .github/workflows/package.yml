name: Package
on: [ push, pull_request ]

jobs:
    package-macos:
        runs-on: macos-latest
        env:
            PIPENV_VENV_IN_PROJECT: 1
            PIPENV_IGNORE_VIRTUALENVS: 1
        steps:
            -   uses: actions/checkout@v4
            -   name: Setup Python Environment
                run: |
                    python3 -m venv .venv
                    source .venv/bin/activate
                    pip3 install pipenv
                    pipenv install pyside6==6.5.2 lxml
            -   name: Build LabelImg (PySide6)
                run: |
                    source .venv/bin/activate
                    pyside6-rcc resources.qrc -o libs/resources.py
                    rm -rf build dist
            -   name: Package LabelImg
                run: |
                    source .venv/bin/activate
                    pipenv run python setup.py py2app --includes=pyside6
                    open dist/labelImg.app
            -   name: Archive macOS app
                run: |
                    cd dist/
                    tar czf labelImg.tgz labelImg.app
            -   uses: actions/upload-artifact@v4
                with:
                    name: macOS artifact
                    path: dist/labelImg.tgz

    package-windows:
        runs-on: windows-latest
        steps:
            -   uses: actions/checkout@v4
            -   name: Setup Python Environment
                run: |
                    pip3 install pyinstaller pyside6==6.5.2 lxml
            -   name: Build LabelImg (PySide6)
                run: |
                    pyside6-rcc resources.qrc -o libs/resources.py
            -   name: Package LabelImg
                run: |
                    pyinstaller --hidden-import=pyside6 --hidden-import=lxml -F -n "labelImg" -c labelImg.py -p ./libs -p ./
            -   uses: actions/upload-artifact@v4
                with:
                    name: Windows artifact
                    path: dist/labelImg.exe

    package-linux:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v4
            -   name: Setup Python Environment
                run: |
                    sudo apt-get update && sudo apt-get install -y libxcb-xinerama0
                    pip3 install pyinstaller pyside6==6.5.2 lxml --break-system-packages
            -   name: Build LabelImg (PySide6)
                run: |
                    pyside6-rcc resources.qrc -o libs/resources.py
            -   name: Package LabelImg
                run: |
                    pyinstaller --hidden-import=pyside6 --hidden-import=lxml -F -n "labelImg" -c labelImg.py -p ./libs -p ./ --break-system-packages
            -   uses: actions/upload-artifact@v4
                with:
                    name: Linux artifact
                    path: dist/labelImg